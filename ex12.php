<?php
error_reporting(0);

$duser = "yDE/TrQHm18mpS3RrwN/wbPh0kvXAfdIph3FoPlSKEA09bFNyAxe+SqUTvvKokx+Oc86J8zgj4kwo0w2FF6VmNLKhq4lJJ6e86/CKT1pr7X66YKJRy53vg9RU+7x4LZ+|l+qjcJVHfeTV5kmCl5R5ul3BXa8x8UuLd38avQrguZk=";
$dcode = "66AViGfKIS6rl6mKqtQMfGNkm3Ot32VDl09fnnoKvoAAi2UwrHMRonupBTRYTo8EnCNbJnnEFM85B6UqQVPlTRKx5IJCpxo2YGSb3Gut1xsgW/t0QPOEURmGhzqlVFmX|n8yrMY64A6rflVbIZM6uHJYMaddFHoijBjtyQjrFs3c=";

$dkey="ec89434eca0835aa83b0f4cc3553a9dab4c5001366b8bf347637a3e644937967";

require_once('php/MysqliDb.php');
require 'kint/Kint.class.php';
require_once('api/encrypt.php');
error_reporting(0);
$userd=mc_decrypt($duser, $dkey);
$passd=mc_decrypt($dcode, $dkey);

$db = new Mysqlidb ($confighost, $userd, $passd, 'suprpaysez');

$arrayVals = ['2018-10-04 23:49:14|2018-10-08 15:36:00|2018100422001471490585123602|2928770047675684427395379678650632572831538668154170|68.00|467.22|0.00|0.00|67.32|462.55|0.68|4.67|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 23:46:56|2018-10-08 15:36:00|2018100422001405290563726477|1425021102312751694258094175510358334191538668016051|347.00|2384.20|0.00|0.00|343.53|2360.36|3.47|23.84|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 23:41:18|2018-10-08 15:36:00|2018100422001493120506702752|2342429504657544352198412529588824428721538667676807|44.00|302.32|0.00|0.00|43.56|299.30|0.44|3.02|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 23:32:59|2018-10-08 15:36:00|2018100422001491270504367948|1844027458789985140392954595518156642451538667178553|26.00|178.64|0.00|0.00|25.74|176.85|0.26|1.79|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 18:13:22|2018-10-08 15:36:00|2018100422001433030500271069|1785390269839572343959283523675305328741538648001992|64.00|439.74|0.00|0.00|63.36|435.34|0.64|4.40|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 17:44:30|2018-10-08 15:36:00|2018100422001445520530915009|2915708217653082095263578722866000757231538646270497|11.00|75.58|0.00|0.00|10.89|74.82|0.11|0.76|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 16:37:33|2018-10-08 15:36:00|2018100422001425770560039670|1882527982734202095276692849226384457071538642253531|56.00|384.77|0.00|0.00|55.44|380.92|0.56|3.85|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 15:09:57|2018-10-08 15:36:00|2018100422001430800577382483|1235084141972233705729166869303336640031538636997112|26.00|178.28|0.00|0.00|25.74|176.50|0.26|1.78|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 15:09:09|2018-10-08 15:36:00|2018100422001455200562799286|1239439453736360875179371995529617588051538636949372|22.00|150.85|0.00|0.00|21.78|149.34|0.22|1.51|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 14:58:41|2018-10-08 15:36:00|2018100422001466510579266907|231782415521219240722369203343194835451538636321753|12.00|82.28|0.00|0.00|11.88|81.46|0.12|0.82|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 14:46:00|2018-10-08 15:36:00|2018100422001444260578759051|1708676616660434307140035842742699223661538635560502|45.00|309.19|0.00|0.00|44.55|306.10|0.45|3.09|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 14:46:00|2018-10-08 15:36:00|2018100422001437850575976900|199572814645495183981553196341607700291538635559970|109.00|748.93|0.00|0.00|107.91|741.44|1.09|7.49|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 14:41:52|2018-10-08 15:36:00|2018100422001497260578769617|3261705892495252689725540143949551685491538635311947|47.00|322.28|0.00|0.00|46.53|319.06|0.47|3.22|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 14:00:15|2018-10-08 15:36:00|2018100422001439250581858488|773242282917166258534191234814297868031538632815568|25.00|171.07|0.00|0.00|24.75|169.36|0.25|1.71|||USD|6.842944|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 09:38:07|2018-10-08 15:36:00|2018100422001475980570653486|2009812948293752625690911163883617565921538617087661|52.00|356.56|0.00|0.00|51.48|352.99|0.52|3.57|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 08:49:22|2018-10-08 15:36:00|2018100422001441750560938227|3344836599945025852821481400620724376931538614159933|128.00|877.70|0.00|0.00|126.72|868.92|1.28|8.78|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-04 08:39:55|2018-10-08 15:36:00|2018100422001441750560976321|1828966900815179864380471251918817801311538613593706|44.00|301.71|0.00|0.00|43.56|298.69|0.44|3.02|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-03 23:35:06|2018-10-08 15:36:00|2018100322001488750560688039|2382182534635459081634352608956624055061538580906776|258.00|1772.69|0.00|0.00|255.42|1754.96|2.58|17.73|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-03 15:24:30|2018-10-08 15:36:00|2018100322001466410580176837|824032198567451634251466590705267822791538551470199|136.00|930.64|0.00|0.00|134.64|921.33|1.36|9.31|||USD|6.842944|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-03 15:12:35|2018-10-08 15:36:00|2018100322001459180594454132|1285827746965863584699221566079983891001538550755749|26.00|178.28|0.00|0.00|25.74|176.50|0.26|1.78|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-03 15:04:52|2018-10-08 15:36:00|2018100322001487470501170709|1739425194582573648734006589050112096941538550292500|26.00|178.28|0.00|0.00|25.74|176.50|0.26|1.78|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-03 14:52:36|2018-10-08 15:36:00|2018100322001443990563196993|2601028768619714274630010907193723509531538549555850|11.00|75.58|0.00|0.00|10.89|74.82|0.11|0.76|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-03 14:27:50|2018-10-08 15:36:00|2018100322001440050598886550|761910754206234771890856459832000333611538548069993|34.25|235.33|0.00|0.00|33.91|232.98|0.34|2.35|||USD|6.870888|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-03 14:20:25|2018-10-08 15:36:00|2018100322001498040599626538|578584094943523494604416953271894180021538547623613|30.50|209.14|0.00|0.00|30.20|207.05|0.30|2.09|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|',
'2018-10-03 14:03:26|2018-10-08 15:36:00|2018100322001456130507715373|2307663560649896853958631626958199798721538546606386|17.00|116.57|0.00|0.00|16.83|115.40|0.17|1.17|||USD|6.857004|Flemingo Duty Free (Departure)|SPOT|P|P|Y|'
];

$arrayVals_reverse = array_reverse($arrayVals);

// echo "<pre>";
// print_r($arrayVals_reverse);
// exit;
// die();

$i = 0; $j = 0;

foreach ($arrayVals_reverse as $key => $var) {
	if($var) {
		$i++; 
		// echo $i.",";
		// // echo $var;
		// echo "<br>";
		$firstexp[$i] = explode("|",$var);
		// echo $firstexp[$i][0];
		// echo "<br>";

		$secondexp[$i] = explode(" ",$firstexp[$i][0]);

		// echo $firstexp[$i][0].'=>'.$secondexp[$i][0].'=>'.$secondexp[$i][1].'<br>';

		if($firstexp[$i][18] == 'R') {
			// $db->where("out_trade_no",$firstexp[$i][3]);
			// $record_check = $db->get('transaction_alipay_test');
			// $count = count($record_check);
			$trans_type[$i] = 2;
		} else if($firstexp[$i][18] == 'P') {
			$trans_type[$i] = 1;
		}

		if($firstexp[$i][18] == 'P' && $firstexp[$i][19] == 'P') {
			$result_code[$i] = 'SUCCESS';
			$trade_status[$i]='TRADE_SUCCESS';
			$total_fee[$i] = $firstexp[$i][4];
			$refund_amount[$i] = NULL;
		} else if($firstexp[$i][18] == 'R' && $firstexp[$i][19] == 'S') {
			$result_code[$i] = 'SUCCESS';
			$trade_status[$i]= NULL;
			$total_fee[$i] = abs($firstexp[$i][4]);
			$refund_amount[$i] = abs($firstexp[$i][4]);
		}

		$data[$i] = Array(
	        "trans_datetime" => $firstexp[$i][0],
	        "trans_time"   => $secondexp[$i][1],
	        "trans_date"   => $secondexp[$i][0],
	        "trade_no"     => ($firstexp[$i][2]!='' ? $firstexp[$i][2] : ''),
	        "out_trade_no" => ($firstexp[$i][3]!='' ? $firstexp[$i][3] : ''),
	        "total_fee"    => $total_fee[$i],
	        "exchange_rate"=> ($firstexp[$i][15]!='' ? $firstexp[$i][15] : ''),
	        "currency"     => ($firstexp[$i][14]!='' ? $firstexp[$i][14] : ''),
	        "transaction_type" => $trans_type[$i],
	        "result_code" => $result_code[$i],
	        "trade_status" => $trade_status[$i],
	        "refund_amount" => $refund_amount[$i],
	        "merchant_id" => 'E01010000000001'
	    );

	    $id_transaction_id = $db->insert('transaction_alipay_temp', $data[$i]);
	    if($id_transaction_id) {
	    	$j++;
	    }

	}
}

echo $i." => ".$j;